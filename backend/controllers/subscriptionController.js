// backend/controllers/subscriptionController.js
const subscriptionService = require('../services/subscriptionService');
const notificationService = require('../services/notificationService');
const User = require('../models/user.model');
const SubscriptionHistory = require('../models/subscriptionHistory.model');

const subscriptionController = {
    
    /**
     * L·∫•y tr·∫°ng th√°i g√≥i hi·ªán t·∫°i
     * GET /api/subscription/status
     */    getSubscriptionStatus: async (req, res) => {
        try {
            // üîç TH√äM LOG CHI TI·∫æT CHO DEBUG TOKEN
            const authHeader = req.headers.authorization;
            console.log('üîç [getSubscriptionStatus] Raw auth header:', authHeader?.substring(0, 50) + '...');
            console.log('üîç [getSubscriptionStatus] req.user:', req.user);
            const userId = req.user.userId; // S·ª≠ d·ª•ng req.user.userId
            console.log('üîç [getSubscriptionStatus] userId:', userId);
            
            const user = await User.findById(userId);
            console.log('üîç [getSubscriptionStatus] user found:', !!user);
            
            if (!user) {
                return res.status(404).json({
                    success: false,
                    message: 'Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng'
                });
            }
            
            // üîç TH√äM LOG CHI TI·∫æT CHO USER
            console.log('üîç [getSubscriptionStatus] User details:');
            console.log('  - email:', user.email);
            console.log('  - current_plan_type:', user.current_plan_type);
            console.log('  - trial_start_date:', user.trial_start_date);
            console.log('  - trial_end_date:', user.trial_end_date);
            console.log('  - subscription_start_date:', user.subscription_start_date);
            console.log('  - subscription_end_date:', user.subscription_end_date);
            console.log('  - createdAt:', user.createdAt);
            
            const planInfo = user.getPlanDisplayInfo();
            const remainingDays = subscriptionService.calculateRemainingDays(user);
            
            console.log('üîç [getSubscriptionStatus] Calculated values:');
            console.log('  - planInfo:', planInfo);
            console.log('  - remainingDays:', remainingDays);
            console.log('  - canAccessService:', user.canAccessService());
            
            // Logic x√°c ƒë·ªãnh subscription type
            let subscriptionType = user.current_plan_type;
            if (!subscriptionType || subscriptionType === null || subscriptionType === undefined) {
                subscriptionType = 'free_trial';
                console.log('üîç [getSubscriptionStatus] No plan type, defaulting to free_trial');
            }
            
            // Logic x√°c ƒë·ªãnh isPremium
            const isPremium = ['monthly', 'yearly'].includes(subscriptionType);
            console.log('üîç [getSubscriptionStatus] isPremium calculation:', {
                subscriptionType,
                isPremium,
                includes: ['monthly', 'yearly'].includes(subscriptionType)
            });
              // Response ƒë∆°n gi·∫£n h√≥a ƒë·ªÉ frontend d·ªÖ s·ª≠ d·ª•ng
            const response = {
                subscriptionType: subscriptionType,
                current_plan_type: subscriptionType, // Th√™m field n√†y ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi frontend
                subscriptionStart: user.subscription_start_date,
                subscriptionEnd: user.subscription_end_date,
                daysRemaining: remainingDays,
                isActive: user.canAccessService(),
                isPremium: isPremium,
                trialUsed: user.trial_start_date ? true : false
            };
            console.log('‚úÖ [getSubscriptionStatus] Final response:', response);
            res.json(response);
        } catch (error) {
            console.error('‚ùå [getSubscriptionStatus] Error:', error);
            res.status(500).json({
                success: false,
                message: 'L·ªói server khi l·∫•y tr·∫°ng th√°i g√≥i d·ªãch v·ª•'
            });
        }
    },
    
    /**
     * N√¢ng c·∫•p g√≥i (through direct admin action)
     * POST /api/subscription/upgrade
     */
    upgradeSubscription: async (req, res) => {
        try {
            const { planType, paymentId, reason } = req.body;
            const userId = req.user.id;
            
            // Validate input
            if (!planType || !['monthly', 'yearly'].includes(planType)) {
                return res.status(400).json({
                    success: false,
                    message: 'Lo·∫°i g√≥i kh√¥ng h·ª£p l·ªá'
                });
            }
            
            const user = await User.findById(userId);
            if (!user) {
                return res.status(404).json({
                    success: false,
                    message: 'Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng'
                });
            }
            
            // Get payment info if paymentId provided
            let paymentInfo = null;
            if (paymentId) {
                const Payment = require('../models/payment.model');
                const payment = await Payment.findById(paymentId);
                if (payment) {
                    paymentInfo = {
                        paymentId: payment._id,
                        amount: payment.amount,
                        reason: reason || 'User upgrade subscription'
                    };
                }
            }
            
            // Trigger upgrade
            const result = await subscriptionService.upgradeSubscription(
                userId, 
                planType, 
                paymentInfo,
                {
                    userId: userId,
                    userType: 'user',
                    ipAddress: req.ip
                }
            );
            
            res.json({
                success: true,
                message: 'N√¢ng c·∫•p g√≥i th√†nh c√¥ng',
                data: {
                    oldPlan: result.oldPlan,
                    newPlan: result.newPlan,
                    planInfo: result.user.getPlanDisplayInfo()
                }
            });
            
        } catch (error) {
            console.error('‚ùå Error upgrading subscription:', error);
            res.status(500).json({
                success: false,
                message: `L·ªói n√¢ng c·∫•p g√≥i: ${error.message}`
            });
        }
    },
    
    /**
     * H·ªßy g√≥i
     * POST /api/subscription/cancel
     */
    cancelSubscription: async (req, res) => {
        try {
            const { reason } = req.body;
            const userId = req.user.id;
            
            const result = await subscriptionService.cancelSubscription(
                userId,
                reason || 'User cancelled subscription',
                {
                    userId: userId,
                    userType: 'user',
                    ipAddress: req.ip
                }
            );
            
            res.json({
                success: true,
                message: 'H·ªßy g√≥i th√†nh c√¥ng',
                data: {
                    oldPlan: result.oldPlan,
                    planInfo: result.user.getPlanDisplayInfo()
                }
            });
            
        } catch (error) {
            console.error('‚ùå Error cancelling subscription:', error);
            res.status(500).json({
                success: false,
                message: `L·ªói h·ªßy g√≥i: ${error.message}`
            });
        }
    },
    
    /**
     * L·∫•y l·ªãch s·ª≠ thay ƒë·ªïi g√≥i
     * GET /api/subscription/history
     */
    getSubscriptionHistory: async (req, res) => {
        try {
            const userId = req.user.id;
            const { limit = 20 } = req.query;
            
            const result = await subscriptionService.getSubscriptionHistory(userId, parseInt(limit));
            
            res.json({
                success: true,
                data: result.history
            });
            
        } catch (error) {
            console.error('‚ùå Error getting subscription history:', error);
            res.status(500).json({
                success: false,
                message: 'L·ªói l·∫•y l·ªãch s·ª≠ g√≥i'
            });
        }
    },
    
    /**
     * Ki·ªÉm tra users s·∫Øp h·∫øt h·∫°n (Admin only)
     * GET /api/subscription/expiring
     */
    getExpiringSubscriptions: async (req, res) => {
        try {
            // Check if user is admin
            const user = await User.findById(req.user.id);
            if (!user || user.role !== 'admin') {
                return res.status(403).json({
                    success: false,
                    message: 'Ch·ªâ admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p'
                });
            }
            
            const expiringUsers = await subscriptionService.checkExpiringSubscriptions();
            
            const result = expiringUsers.map(user => ({
                id: user._id,
                email: user.email,
                fullname: user.fullname,
                currentPlan: user.current_plan_type,
                planInfo: user.getPlanDisplayInfo(),
                remainingDays: subscriptionService.calculateRemainingDays(user),
                trialEndDate: user.trial_end_date,
                subscriptionEndDate: user.subscription_end_date
            }));
            
            res.json({
                success: true,
                data: {
                    count: result.length,
                    users: result
                }
            });
            
        } catch (error) {
            console.error('‚ùå Error getting expiring subscriptions:', error);
            res.status(500).json({
                success: false,
                message: 'L·ªói l·∫•y danh s√°ch g√≥i s·∫Øp h·∫øt h·∫°n'
            });
        }
    },
    
    /**
     * G·ª≠i th√¥ng b√°o c·∫£nh b√°o th·ªß c√¥ng (Admin only)
     * POST /api/subscription/send-warning
     */
    sendExpiryWarning: async (req, res) => {
        try {
            const { userId } = req.body;
            
            // Check if user is admin
            const adminUser = await User.findById(req.user.id);
            if (!adminUser || adminUser.role !== 'admin') {
                return res.status(403).json({
                    success: false,
                    message: 'Ch·ªâ admin m·ªõi c√≥ quy·ªÅn th·ª±c hi·ªán'
                });
            }
            
            const user = await User.findById(userId);
            if (!user) {
                return res.status(404).json({
                    success: false,
                    message: 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng'
                });
            }
            
            const remainingDays = subscriptionService.calculateRemainingDays(user);
            
            let result;
            if (user.current_plan_type === 'free_trial') {
                result = await notificationService.sendTrialExpiryWarning(userId, remainingDays);
            } else if (['monthly', 'yearly'].includes(user.current_plan_type)) {
                result = await notificationService.sendSubscriptionExpiryWarning(userId, remainingDays, user.current_plan_type);
            } else {
                return res.status(400).json({
                    success: false,
                    message: 'User kh√¥ng c√≥ g√≥i active ƒë·ªÉ g·ª≠i c·∫£nh b√°o'
                });
            }
            
            res.json({
                success: true,
                message: 'ƒê√£ g·ª≠i c·∫£nh b√°o th√†nh c√¥ng',
                data: {
                    userId: userId,
                    userEmail: user.email,
                    remainingDays: remainingDays,
                    notificationId: result.notification._id
                }
            });
            
        } catch (error) {
            console.error('‚ùå Error sending expiry warning:', error);
            res.status(500).json({
                success: false,
                message: 'L·ªói g·ª≠i c·∫£nh b√°o'
            });
        }
    },
    
    /**
     * L·∫•y th·ªëng k√™ subscription (Admin only)
     * GET /api/subscription/stats
     */
    getSubscriptionStats: async (req, res) => {
        try {
            // Check if user is admin
            const user = await User.findById(req.user.id);
            if (!user || user.role !== 'admin') {
                return res.status(403).json({
                    success: false,
                    message: 'Ch·ªâ admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p'
                });
            }
            
            const stats = await User.aggregate([
                {
                    $group: {
                        _id: '$current_plan_type',
                        count: { $sum: 1 }
                    }
                }
            ]);
            
            const totalUsers = await User.countDocuments();
            const activeSubscriptions = await User.countDocuments({
                current_plan_type: { $in: ['free_trial', 'monthly', 'yearly'] }
            });
            
            // Revenue calculation (basic)
            const monthlyRevenue = await User.countDocuments({ current_plan_type: 'monthly' }) * 500000;
            const yearlyRevenue = await User.countDocuments({ current_plan_type: 'yearly' }) * 3000000;
            
            res.json({
                success: true,
                data: {
                    totalUsers: totalUsers,
                    activeSubscriptions: activeSubscriptions,
                    planDistribution: stats.reduce((acc, item) => {
                        acc[item._id] = item.count;
                        return acc;
                    }, {}),
                    revenue: {
                        monthly: monthlyRevenue,
                        yearly: yearlyRevenue,
                        total: monthlyRevenue + yearlyRevenue
                    }
                }
            });
            
        } catch (error) {
            console.error('‚ùå Error getting subscription stats:', error);
            res.status(500).json({
                success: false,
                message: 'L·ªói l·∫•y th·ªëng k√™'
            });
        }
    },    /**
     * @desc L·∫•y t·∫•t c·∫£ th√¥ng b√°o cho ng∆∞·ªùi d√πng hi·ªán t·∫°i
     */
    getNotifications: async (req, res) => {
        try {
            if (!req.user || (!req.user.id && !req.user.userId)) {
                return res.status(401).json({ message: "Kh√¥ng c√≥ th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i." });
            }
            const userId = req.user.id || req.user.userId;
            const notifications = await notificationService.getNotifications(userId);
            res.status(200).json(notifications);
        } catch (error) {
            console.error("Error in getNotifications controller:", error);
            if (!res.headersSent) {
                res.status(500).json({ message: "L·ªói khi l·∫•y danh s√°ch th√¥ng b√°o.", error: error.message });
            }
        }
    },    /**
     * @desc ƒê√°nh d·∫•u m·ªôt th√¥ng b√°o l√† ƒë√£ ƒë·ªçc
     */
    markNotificationAsRead: async (req, res) => {
        try {
            if (!req.user || (!req.user.id && !req.user.userId)) {
                return res.status(401).json({ message: "Kh√¥ng c√≥ th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i." });
            }

            const { notificationId } = req.body;
            const userId = req.user.id || req.user.userId;

            if (!notificationId) {
                return res.status(400).json({ message: 'Thi·∫øu ID c·ªßa th√¥ng b√°o.' });
            }

            await notificationService.markNotificationAsRead(notificationId, userId);
            res.status(200).json({ message: "ƒê√£ ƒë√°nh d·∫•u th√¥ng b√°o l√† ƒë√£ ƒë·ªçc." });
        } catch (error) {
            console.error("Error in markNotificationAsRead controller:", error);
            res.status(500).json({ message: "L·ªói khi ƒë√°nh d·∫•u th√¥ng b√°o.", error: error.message });
        }
    },    /**
     * @desc ƒê√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o l√† ƒë√£ ƒë·ªçc
     */
    markAllNotificationsAsRead: async (req, res) => {
        try {
            if (!req.user || (!req.user.id && !req.user.userId)) {
                return res.status(401).json({ message: "Kh√¥ng c√≥ th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i." });
            }
            
            const userId = req.user.id || req.user.userId;
            await notificationService.markAllNotificationsAsRead(userId);
            res.status(200).json({ message: "ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o l√† ƒë√£ ƒë·ªçc." });
        } catch (error) {
            console.error("Error in markAllNotificationsAsRead controller:", error);
            res.status(500).json({ message: "L·ªói khi ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o.", error: error.message });
        }
    }
};

module.exports = subscriptionController;
